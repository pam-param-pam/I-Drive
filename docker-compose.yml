name: i-drive-dc
volumes:
  backend-db:

services:

  ### redis
  redis:
    container_name: idrive-redis
    image: redis:latest
    restart: unless-stopped
    #healthcheck:
    #  test: [ "CMD-SHELL", "ls" ]
    #  interval: 10s
    #  retries: 10

    deploy:
      resources:
        limits:
          memory: 256M

  ### Main backend
  
  backend:
    container_name: idrive-backend
    image: ghcr.io/pam-param-pam/idrive-backend:${BACKENDTAG-latest}
#    platform: linux/arm64
    pull_policy: missing
    build:
      context: ./backend
    restart: unless-stopped
    ports:
      - ${BACKEND_PORT:-8001}:8000
    healthcheck:  # DO POPRAWY
      test: [ "CMD-SHELL", "ls" ]
      interval: 10s
      retries: 10
    environment:
      # Django Secret Key
      - I_DRIVE_BACKEND_SECRET_KEY=${I_DRIVE_BACKEND_SECRET_KEY}

      # General
      - IS_DEV_ENV=${IS_DEV_ENV:-false}
      - DEPLOYMENT_HOST=${DEPLOYMENT_HOST:-localhost:2137}
      - BACKEND_BASE_URL=${PROTOCOL:-http}://${DEPLOYMENT_HOST}/api

      # Redis Configuration
      - I_DRIVE_REDIS_ADDRESS=redis
      - I_DRIVE_REDIS_PORT=6379

      # Storage Directory
      - I_DRIVE_BACKEND_STORAGE_DIR=/app/data

    volumes:
      - backend-db:/app/data
    deploy:
      resources:
        limits:
          memory: 1G


 ### nginx

  nginx:
    image: ghcr.io/pam-param-pam/idrive-nginx:${NGINXTAG-latest}
    container_name: idrive-nginx
#    platforms:
#      -linux/arm64

    build:
      context: ./frontend
    restart: unless-stopped
    ports:
      - ${NGINX_PORT:-2137}:80
    depends_on:
      backend:
        condition: service_healthy
    healthcheck: ### KWESTIA PORTU DO SPRAWDZENIA
      test: [ "CMD-SHELL", "curl http://localhost:80/healthcheck || exit 1" ]
      interval: 10s
      retries: 10
    environment:
      - VITE_BACKEND_BASE_URL=${PROTOCOL:-http}://${DEPLOYMENT_HOST:-localhost:2137}/api # todo PORTS may be diffrent
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf

    deploy:
      resources:
        limits:
          memory: 64M