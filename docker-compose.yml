name: i-drive-dc
volumes:
  backend-db:

services:

  ### redis
  ### todo force docker to delete cache on restart cuz yes
  redis:
    container_name: idrive-redis
    image: redis:latest
    restart: unless-stopped
    #healthcheck:
    #  test: [ "CMD-SHELL", "ls" ]
    #  interval: 10s
    #  retries: 10

    deploy:
      resources:
        limits:
          memory: 256M

  ### Main backend
  
  backend:
    container_name: idrive-backend
    image: pamparampam/idrive-backend:${BACKENDTAG-latest}
    pull_policy: missing
    build:
      context: ./backend
    restart: unless-stopped
    ports:
      - 8000:8000
    healthcheck:  # DO POPRAWY
      test: [ "CMD-SHELL", "ls" ]
      interval: 10s
      retries: 10

    volumes:
      - backend-db:${I_DRIVE_BACKEND_STORAGE_DIR}
    deploy:
      resources:
        limits:
          memory: 1G


 ### nginx

  nginx:
    image: pamparampam/idrive-nginx:${NGINXTAG-latest}
    container_name: idrive-nginx
    build:
      context: ./frontend
    restart: unless-stopped
    ports:
      - 8080:80
    depends_on:
      backend:
        condition: service_healthy
    healthcheck: ### KWESTIA PORTU DO SPRAWDZENIA
      test: [ "CMD-SHELL", "curl http://localhost:80/healthcheck || exit 1" ]
      interval: 10s
      retries: 10

    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    deploy:
      resources:
        limits:
          memory: 64M