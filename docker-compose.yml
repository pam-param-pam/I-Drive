
name: i-drive-dc

services:

  ### redis
  
  redis:
    container_name: i-drive-redis
    image: redis:latest
    restart: unless-stopped
    ports:
      - 6379:6379   # tbc
    #healthcheck:
    #  test: [ "CMD-SHELL", "ls" ]
    #  interval: 10s
    #  retries: 10



  
  ### Main backend
  
  backend:
    container_name: i-drive-backend
    image: pamparampam/i-drive-backend:latest
    restart: unless-stopped
    ports:
      - 8000:8000
    depends_on:
      streamer-be:
        condition: service_healthy
    #  - redis:
    command: sh -c "while true; do sleep 3600; done"
    healthcheck:
      test: [ "CMD-SHELL", "ls" ]
      interval: 10s
      retries: 10
    deploy:
      resources:
        limits:
          memory: 64M


### Streamer backend
  
  streamer-be:
    container_name: i-drive-streamer-be
    image: busybox:latest
    restart: unless-stopped
    ports:
      - 8050:8050
    depends_on:
      - redis
    command: sh -c "while true; do sleep 3600; done"
    healthcheck:
      test: [ "CMD-SHELL", "ls" ]
      interval: 10s
      retries: 10
    deploy:
      resources:
        limits:
          memory: 64M


 ### nginx

  nginx:
    image: nginx:1.26.0-alpine
    container_name: i-drive-nginx
    restart: unless-stopped
    ports:
      - 8080:80
    depends_on:
      backend:
        condition: service_healthy
      streamer-be:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:80 || exit 1" ]
      interval: 10s
      retries: 10
    #volumes:
    #  - ./nginx/nginx.conf:/etc/nginx/nginx.conf
    deploy:
      resources:
        limits:
          memory: 64M